using System;using System.IO;using Avid.PaymentService;using Avid.PaymentService.Options;using Avid.PaymentService.Payments;using Avid.PaymentService.DigitalWallet;using Avid.PaymentService.DigitalWallet.Options;using Avid.PaymentService.DigitalWallet.PaymentService;using Avid.PaymentService.DigitalWallet.Web;using Avid.PaymentService.DigitalWallet.WithdrawalRequests;using Avid.PaymentService.Web;using Avid.PaymentService.WeChatPay;using Avid.PaymentService.WeChatPay.Web;using Localization.Resources.AbpUi;using Microsoft.AspNetCore.Builder;using Microsoft.AspNetCore.Hosting;using Microsoft.Extensions.Configuration;using Microsoft.Extensions.DependencyInjection;using Microsoft.Extensions.Hosting;using PaymentServiceSample.EntityFrameworkCore;using PaymentServiceSample.Localization;using PaymentServiceSample.MultiTenancy;using PaymentServiceSample.Web.Menus;using Microsoft.OpenApi.Models;using Volo.Abp;using Volo.Abp.Account.Web;using Volo.Abp.AspNetCore.Authentication.JwtBearer;using Volo.Abp.AspNetCore.Mvc;using Volo.Abp.AspNetCore.Mvc.Localization;using Volo.Abp.AspNetCore.Mvc.UI.Bundling;using Volo.Abp.AspNetCore.Mvc.UI.Theme.LeptonXLite;using Volo.Abp.AspNetCore.Mvc.UI.Theme.LeptonXLite.Bundling;using Volo.Abp.AspNetCore.Mvc.UI.Theme.Shared;using Volo.Abp.AspNetCore.Serilog;using Volo.Abp.Autofac;using Volo.Abp.AutoMapper;using Volo.Abp.Data;using Volo.Abp.FeatureManagement;using Volo.Abp.Identity.Web;using Volo.Abp.Localization;using Volo.Abp.Modularity;using Volo.Abp.SettingManagement.Web;using Volo.Abp.Swashbuckle;using Volo.Abp.TenantManagement.Web;using Volo.Abp.Threading;using Volo.Abp.UI.Navigation.Urls;using Volo.Abp.UI.Navigation;using Volo.Abp.VirtualFileSystem;namespace PaymentServiceSample.Web{    [DependsOn(        typeof(PaymentServiceSampleHttpApiModule),        typeof(PaymentServiceSampleApplicationModule),        typeof(PaymentServiceSampleEntityFrameworkCoreModule),        typeof(AbpAutofacModule),        typeof(AbpIdentityWebModule),        typeof(AbpAccountWebIdentityServerModule),        typeof(AbpAspNetCoreMvcUiLeptonXLiteThemeModule),        typeof(AbpAspNetCoreAuthenticationJwtBearerModule),        typeof(AbpTenantManagementWebModule),        typeof(AbpFeatureManagementWebModule),        typeof(AbpSettingManagementWebModule),        typeof(AbpSwashbuckleModule),        typeof(AbpAspNetCoreSerilogModule),        typeof(PaymentServiceWebModule),        typeof(PaymentServiceDigitalWalletWebModule),        typeof(PaymentServiceWeChatPayWebModule)        )]    public class PaymentServiceSampleWebModule : AbpModule    {        public override void PreConfigureServices(ServiceConfigurationContext context)        {            context.Services.PreConfigure<AbpMvcDataAnnotationsLocalizationOptions>(options =>            {                options.AddAssemblyResource(                    typeof(PaymentServiceSampleResource),                    typeof(PaymentServiceSampleDomainModule).Assembly,                    typeof(PaymentServiceSampleDomainSharedModule).Assembly,                    typeof(PaymentServiceSampleApplicationModule).Assembly,                    typeof(PaymentServiceSampleApplicationContractsModule).Assembly,                    typeof(PaymentServiceSampleWebModule).Assembly                );            });        }        public override void ConfigureServices(ServiceConfigurationContext context)        {            var hostingEnvironment = context.Services.GetHostingEnvironment();            var configuration = context.Services.GetConfiguration();            ConfigureUrls(configuration);            ConfigureBundles();            ConfigureAuthentication(context, configuration);            ConfigureAutoMapper();            ConfigureVirtualFileSystem(hostingEnvironment);            ConfigureLocalizationServices();            ConfigureNavigationServices();            ConfigureAutoApiControllers();            ConfigureSwaggerServices(context.Services);            ConfigurePaymentServiceDigitalWallet();        }        private void ConfigureBundles()        {            Configure<AbpBundlingOptions>(options =>            {                options.StyleBundles.Configure(                    LeptonXLiteThemeBundles.Styles.Global,                    bundle => { bundle.AddFiles("/global-styles.css"); }                );            });        }        private void ConfigureAuthentication(ServiceConfigurationContext context, IConfiguration configuration)        {            context.Services.AddAuthentication()                .AddJwtBearer(options =>                {                    options.Authority = configuration["AuthServer:Authority"];                    options.RequireHttpsMetadata = Convert.ToBoolean(configuration["AuthServer:RequireHttpsMetadata"]);                    options.Audience = "PaymentServiceSample";                });        }        private void ConfigurePaymentServiceDigitalWallet()        {            Configure<PaymentServiceOptions>(options =>            {                options.Providers.Configure<FreePaymentServiceProvider>(FreePaymentServiceProvider.PaymentMethod);                options.Providers.Configure<DigitalWalletPaymentServiceProvider>(DigitalWalletPaymentServiceProvider.PaymentMethod);                options.Providers.Configure<WeChatPayPaymentServiceProvider>(WeChatPayPaymentServiceProvider.PaymentMethod);            });                        Configure<PaymentServiceDigitalWalletOptions>(options =>            {                options.AccountGroups.Configure<DefaultAccountGroup>(accountGroup =>                {                    accountGroup.Currency = "CNY";                });                                options.AccountGroups.Configure<CustomAccountGroup>(accountGroup =>                {                    accountGroup.Currency = "CNY";                    accountGroup.AllowedUsingToTopUpOtherAccounts = true;                });                options.WithdrawalMethods.Configure<NullWithdrawalMethod>(withdrawalMethod =>                {                    withdrawalMethod.AccountWithdrawalProviderType = typeof(NullAccountWithdrawalProvider);                    withdrawalMethod.DailyMaximumWithdrawalAmountEachAccount = 1m;                });                                options.WithdrawalMethods.Configure<ManualWithdrawalMethod>(withdrawalMethod =>                {                    withdrawalMethod.AccountWithdrawalProviderType = typeof(ManualAccountWithdrawalProvider);                    withdrawalMethod.DailyMaximumWithdrawalAmountEachAccount = 5m;                });            });        }        private void ConfigureUrls(IConfiguration configuration)        {            Configure<AppUrlOptions>(options =>            {                options.Applications["MVC"].RootUrl = configuration["App:SelfUrl"];            });        }        private void ConfigureAutoMapper()        {            Configure<AbpAutoMapperOptions>(options =>            {                options.AddMaps<PaymentServiceSampleWebModule>();            });        }        private void ConfigureVirtualFileSystem(IWebHostEnvironment hostingEnvironment)        {            if (hostingEnvironment.IsDevelopment())            {                Configure<AbpVirtualFileSystemOptions>(options =>                {                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceSampleDomainSharedModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}PaymentServiceSample.Domain.Shared"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceSampleDomainModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}PaymentServiceSample.Domain"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceSampleApplicationContractsModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}PaymentServiceSample.Application.Contracts"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceSampleApplicationModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}PaymentServiceSample.Application"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceSampleWebModule>(hostingEnvironment.ContentRootPath);                                        options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDomainSharedModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.Domain.Shared"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDomainModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.Domain"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceApplicationContractsModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.Application.Contracts"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceApplicationModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.Application"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWebModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.Web"));                                                            options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWeChatPayDomainSharedModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay.Domain.Shared"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWeChatPayDomainModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay.Domain"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWeChatPayApplicationContractsModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay.Application.Contracts"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWeChatPayApplicationModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay.Application"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceWeChatPayWebModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.WeChatPay.Web"));                                        options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDigitalWalletDomainSharedModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet.Domain.Shared"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDigitalWalletDomainModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet.Domain"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDigitalWalletApplicationContractsModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet.Application.Contracts"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDigitalWalletApplicationModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet.Application"));                    options.FileSets.ReplaceEmbeddedByPhysical<PaymentServiceDigitalWalletWebModule>(Path.Combine(hostingEnvironment.ContentRootPath, $"..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}..{Path.DirectorySeparatorChar}modules{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet{Path.DirectorySeparatorChar}src{Path.DirectorySeparatorChar}Avid.PaymentService.DigitalWallet.Web"));                });            }        }        private void ConfigureLocalizationServices()        {            Configure<AbpLocalizationOptions>(options =>            {                options.Resources                    .Get<PaymentServiceSampleResource>()                    .AddBaseTypes(                        typeof(AbpUiResource)                    );                options.Languages.Add(new LanguageInfo("cs", "cs", "Ceština"));                options.Languages.Add(new LanguageInfo("en", "en", "English"));                options.Languages.Add(new LanguageInfo("pt-BR", "pt-BR", "Português"));                options.Languages.Add(new LanguageInfo("ru", "ru", "???????"));                options.Languages.Add(new LanguageInfo("tr", "tr", "Türkçe"));                options.Languages.Add(new LanguageInfo("zh-Hans", "zh-Hans", "????"));                options.Languages.Add(new LanguageInfo("zh-Hant", "zh-Hant", "????"));            });        }        private void ConfigureNavigationServices()        {            Configure<AbpNavigationOptions>(options =>            {                options.MenuContributors.Add(new PaymentServiceSampleMenuContributor());            });        }        private void ConfigureAutoApiControllers()        {            PreConfigure<AbpAspNetCoreMvcOptions>(options =>            {                options.ConventionalControllers.Create(typeof(PaymentServiceSampleApplicationModule).Assembly);            });        }        private void ConfigureSwaggerServices(IServiceCollection services)        {            services.AddAbpSwaggerGen(                options =>                {                    options.SwaggerDoc("v1", new OpenApiInfo { Title = "PaymentServiceSample API", Version = "v1" });                    options.DocInclusionPredicate((docName, description) => true);                    options.CustomSchemaIds(type => type.FullName);                }            );                        // // Register the Swagger services            // services.AddSwaggerDocument(options =>            // {            //     options.DocumentName = "AvidPaymentService";            //     options.ApiGroupNames = new[] {"AvidPaymentService"};            //     options.Title = "Avid PaymentService API";            // });            //            // services.AddSwaggerDocument(options =>            // {            //     options.DocumentName = "AvidPaymentServiceDigitalWallet";            //     options.ApiGroupNames = new[] {"AvidPaymentServiceDigitalWallet"};            //     options.Title = "Avid PaymentService DigitalWallet API";            // });            //            // services.AddSwaggerDocument(options =>            // {            //     options.DocumentName = "AvidPaymentServiceWeChatPay";            //     options.ApiGroupNames = new[] {"AvidPaymentServiceWeChatPay"};            //     options.Title = "Avid PaymentService WeChatPay API";            // });            //            // services.AddSwaggerDocument(options =>            // {            //     options.Title = "PaymentServiceSample API";            // });        }        public override void OnApplicationInitialization(ApplicationInitializationContext context)        {            var app = context.GetApplicationBuilder();            var env = context.GetEnvironment();            if (env.IsDevelopment())            {                app.UseDeveloperExceptionPage();            }            app.UseAbpRequestLocalization();            if (!env.IsDevelopment())            {                app.UseErrorPage();            }            app.UseCorrelationId();            app.MapAbpStaticAssets();            app.UseRouting();            app.UseAuthentication();            app.UseJwtTokenMiddleware();            if (MultiTenancyConsts.IsEnabled)            {                app.UseMultiTenancy();            }            app.UseUnitOfWork();            app.UseIdentityServer();            app.UseAuthorization();            app.UseSwagger();            app.UseAbpSwaggerUI(options =>            {                options.SwaggerEndpoint("/swagger/v1/swagger.json", "PaymentServiceSample API");            });            app.UseAuditing();            app.UseAbpSerilogEnrichers();            app.UseConfiguredEndpoints();            using (var scope = context.ServiceProvider.CreateScope())            {                AsyncHelper.RunSync(async () =>                {                    await scope.ServiceProvider                        .GetRequiredService<IDataSeeder>()                        .SeedAsync();                });            }        }    }}